<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íˆí¬ ë„ê° ë³€í™˜ê¸° (ì´ˆì •ë°€ ëª¨ë“œ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #10b981; --bg: #f8fafc; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h1 { color: var(--primary); text-align: center; font-weight: 900; font-size: 1.8rem; margin-bottom: 20px; }
        .upload-zone { border: 3px dashed #e2e8f0; padding: 40px; text-align: center; cursor: pointer; border-radius: 15px; transition: 0.2s; background: #fff; }
        .upload-zone:hover { border-color: var(--primary); background: #f0fdf4; }
        .sheet-card { background: #f1f5f9; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .mapping-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .field-item { display: flex; flex-direction: column; gap: 5px; }
        .field-label { font-size: 0.8rem; font-weight: bold; color: #64748b; }
        select { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; background: white; font-size: 0.9rem; }
        .btn-save { width: 100%; padding: 18px; background: #1e293b; color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.2s; }
        .btn-save:hover { background: #0f172a; }
        .info-box { background: #eff6ff; color: #1e40af; padding: 15px; border-radius: 10px; font-size: 0.85rem; margin-bottom: 20px; line-height: 1.5; }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fa-solid fa-file-excel"></i> ë°ì´í„° ë³€í™˜ê¸° (Column ëª¨ë“œ)</h1>
    
    <div class="info-box">
        ğŸ’¡ <b>ì‚¬ìš© ë°©ë²•:</b><br>
        1. ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.<br>
        2. ê° ì‹œíŠ¸ê°€ ì–´ë–¤ <b>ì¹´í…Œê³ ë¦¬</b>ì¸ì§€ ì„ íƒí•˜ì„¸ìš”.<br>
        3. <b>ì´ë¦„</b>ê³¼ <b>ë ˆë²¨</b>ì´ ë“¤ì–´ìˆëŠ” ì—´(A, B, C...)ì„ ì •í™•íˆ ê³¨ë¼ì£¼ì„¸ìš”.
    </div>

    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
        <p class="font-bold text-slate-500">í´ë¦­í•˜ì—¬ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</p>
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
    </div>

    <div id="setupArea" style="display:none;">
        <div id="sheetsContainer"></div>
        <button class="btn-save" id="downloadBtn">JSON íŒŒì¼ë¡œ ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<script>
    let wb = null;
    // ì—‘ì…€ ì—´ ì¸ë±ìŠ¤ë¥¼ A, B, C... ë¬¸ìë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function getColLetter(n) {
        let s = "";
        while(n >= 0) {
            s = String.fromCharCode(n % 26 + 65) + s;
            n = Math.floor(n / 26) - 1;
        }
        return s;
    }

    const fields = [
        { key: 'name', label: 'ì´ë¦„(í•„ìˆ˜)*' },
        { key: 'level', label: 'ë ˆë²¨(í•„ìˆ˜)*' },
        { key: 'location', label: 'ì¥ì†Œ/ìœ„ì¹˜' },
        { key: 'weather', label: 'ë‚ ì”¨' },
        { key: 'time', label: 'ì‹œê°„' },
        { key: 'price', label: 'ê°€ê²©' },
        { key: 'size', label: 'í¬ê¸°/ê·¸ë¦¼ì' },
        { key: 'sub_type', label: 'ì¢…ë¥˜/êµ¬ë¶„' },
        { key: 'memo', label: 'ë©”ëª¨' }
    ];

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            wb = XLSX.read(evt.target.result, { type: 'binary' });
            renderSheets();
        };
        reader.readAsBinaryString(file);
    });

    function renderSheets() {
        const container = document.getElementById('sheetsContainer');
        container.innerHTML = "";
        
        wb.SheetNames.forEach((sheetName, idx) => {
            const sheet = wb.Sheets[sheetName];
            // ì—´ì˜ ê°œìˆ˜ë¥¼ íŒŒì•…í•˜ê¸° ìœ„í•´ ë²”ìœ„ í™•ì¸
            const range = XLSX.utils.decode_range(sheet['!ref'] || "A1:Z1");
            const colCount = range.e.c + 1;
            const colOptions = [];
            for(let i=0; i<colCount; i++) {
                colOptions.push(getColLetter(i));
            }

            const card = document.createElement('div');
            card.className = 'sheet-card';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <strong style="font-size:1.1rem;">ì‹œíŠ¸: ${sheetName}</strong>
                    <select class="cat-select" style="width:140px; border-color:var(--primary); font-weight:bold;">
                        <option value="ë¯¸ì‚¬ìš©">-- ë¯¸ì‚¬ìš© --</option>
                        <option value="ë‚šì‹œ" ${sheetName.includes('ë‚šì‹œ')?'selected':''}>ë‚šì‹œ</option>
                        <option value="ìš”ë¦¬" ${sheetName.includes('ìš”ë¦¬')?'selected':''}>ìš”ë¦¬</option>
                        <option value="ì›ì˜ˆ" ${sheetName.includes('ì›ì˜ˆ')?'selected':''}>ì›ì˜ˆ</option>
                        <option value="ìƒˆ ê´€ì°°" ${sheetName.includes('ìƒˆ')?'selected':''}>ìƒˆ ê´€ì°°</option>
                        <option value="ê³¤ì¶© ì±„ì§‘" ${sheetName.includes('ê³¤ì¶©')?'selected':''}>ê³¤ì¶© ì±„ì§‘</option>
                    </select>
                </div>
                <div class="mapping-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    ${fields.map((f, fIdx) => `
                        <div class="field-item">
                            <span class="field-label">${f.label}</span>
                            <select class="col-match" data-field="${f.key}" data-sheet="${sheetName}">
                                <option value="">-- ì„ íƒ ì•ˆí•¨ --</option>
                                ${colOptions.map((letter, lIdx) => `<option value="${lIdx}" ${fIdx === lIdx ? 'selected' : ''}>${letter}ì—´</option>`).join('')}
                            </select>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(card);
        });
        document.getElementById('setupArea').style.display = 'block';
    }

    document.getElementById('downloadBtn').addEventListener('click', function() {
        const finalJson = { "ë‚šì‹œ":[], "ìš”ë¦¬":[], "ì›ì˜ˆ":[], "ìƒˆ ê´€ì°°":[], "ê³¤ì¶© ì±„ì§‘":[], "my_levels": {"ë‚šì‹œ":1,"ìš”ë¦¬":1,"ì›ì˜ˆ":1,"ìƒˆ ê´€ì°°":1,"ê³¤ì¶© ì±„ì§‘":1} };
        let hasData = false;

        document.querySelectorAll('.sheet-card').forEach(card => {
            const cat = card.querySelector('.cat-select').value;
            if (cat === "ë¯¸ì‚¬ìš©") return;

            const sheetName = card.querySelector('.col-match').dataset.sheet;
            const sheet = wb.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 }); // ë°°ì—´ í˜•íƒœë¡œ ê°€ì ¸ì˜´

            const mapping = {};
            card.querySelectorAll('.col-match').forEach(sel => {
                if(sel.value !== "") mapping[sel.dataset.field] = parseInt(sel.value);
            });

            // ë°ì´í„° ì¶”ì¶œ (ì²« ì¤„ì€ ì œëª©ì¼ í™•ë¥ ì´ ë†’ìœ¼ë¯€ë¡œ 1ë²ˆ ì¸ë±ìŠ¤ë¶€í„° ì‹œì‘í•˜ê±°ë‚˜ ì²´í¬)
            rows.forEach((row, rIdx) => {
                const getVal = (f) => (mapping[f] !== undefined && row[mapping[f]]) ? String(row[mapping[f]]) : "";
                
                if (!getVal('name') || getVal('name') === "ì´ë¦„") return; // ì´ë¦„ì´ ì—†ê±°ë‚˜ ì œëª©í–‰ì¸ ê²½ìš° íŒ¨ìŠ¤

                finalJson[cat].push({
                    "name": getVal('name'),
                    "level": getVal('level').replace(/[^0-9]/g, '') || "1",
                    "location": getVal('location'),
                    "weather": getVal('weather') || "ë¬´ê´€",
                    "time": getVal('time') || "ì¢…ì¼",
                    "price": getVal('price').replace(/[^0-9]/g, ''),
                    "size": getVal('size'),
                    "stars": [false, false, false, false, false],
                    "img_path": "",
                    "memo": getVal('memo'),
                    "sub_type": getVal('sub_type')
                });
                hasData = true;
            });
        });

        if(!hasData) return alert("ë³€í™˜í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

        let name = prompt("ì €ì¥í•  íŒŒì¼ëª…:", "ë„ê°ë°ì´í„°.json");
        if(!name) return;
        
        const blob = new Blob([JSON.stringify(finalJson, null, 4)], {type: "application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = name.endsWith(".json") ? name : name + ".json";
        a.click();
    });
</script>
</body>
</html>
