<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë„ê° ë°ì´í„° ì •ë°€ ë³€í™˜ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #4CAF50; --bg: #f4f7f6; }
        body { font-family: 'Malgun Gothic', sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 15px; shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); text-align: center; border-bottom: 2px solid var(--primary); padding-bottom: 15px; }
        .upload-zone { border: 3px dashed var(--primary); padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px; border-radius: 10px; }
        .sheet-card { background: #f9f9f9; border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 10px; }
        .mapping-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-top: 15px; }
        select { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .btn-save { width: 100%; padding: 20px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.2em; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .status { text-align: center; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ë„ê° ë°ì´í„° ë³€í™˜ê¸°</h1>
    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
        <strong>ğŸ“ ìƒˆë¡œìš´ ì—‘ì…€ íŒŒì¼ì„ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</strong>
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
    </div>

    <div id="setupArea" style="display:none;">
        <div id="sheetsContainer"></div>
        <button class="btn-save" id="downloadBtn">JSON íŒŒì¼ë¡œ ë³€í™˜ ë° ì €ì¥</button>
        <div id="status" class="status"></div>
    </div>
</div>

<script>
    let workbook = null;
    const fields = [
        { key: 'name', label: 'ì´ë¦„*', hints: ['ì´ë¦„', 'ëª…ì¹­', 'ë¬¼ê³ ê¸°', 'ì‘ë¬¼', 'í’ˆëª…'] },
        { key: 'level', label: 'ë ˆë²¨*', hints: ['ë ˆë²¨', 'ë‚œì´ë„', 'Lv'] },
        { key: 'location', label: 'ì¥ì†Œ', hints: ['ì¥ì†Œ', 'íšë“', 'ìœ„ì¹˜'] },
        { key: 'weather', label: 'ë‚ ì”¨', hints: ['ë‚ ì”¨', 'ê¸°ìƒ'] },
        { key: 'time', label: 'ì‹œê°„', hints: ['ì‹œê°„', 'ì†Œìš”'] },
        { key: 'price', label: 'ê°€ê²©', hints: ['ê°€ê²©', 'ê¸ˆì•¡', 'íŒë§¤'] },
        { key: 'size', label: 'í¬ê¸°', hints: ['í¬ê¸°', 'ì‚¬ì´ì¦ˆ'] },
        { key: 'sub_type', label: 'êµ¬ë¶„', hints: ['êµ¬ë¶„', 'ì¢…ë¥˜', 'íƒ€ì…'] },
        { key: 'memo', label: 'ë©”ëª¨', hints: ['ë©”ëª¨', 'ë¹„ê³ '] }
    ];

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            workbook = XLSX.read(evt.target.result, { type: 'binary' });
            renderSheets();
        };
        reader.readAsBinaryString(file);
    });

    function renderSheets() {
        const container = document.getElementById('sheetsContainer');
        container.innerHTML = "";
        workbook.SheetNames.forEach((sheetName, idx) => {
            const sheet = workbook.Sheets[sheetName];
            const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            if (rawData.length === 0) return;
            
            // ì²« ë²ˆì§¸ ìœ íš¨í•œ í–‰(ë°ì´í„°ê°€ ìˆëŠ” í–‰)ì„ í—¤ë”ë¡œ ì°¾ê¸°
            const headers = rawData.find(row => row.length > 0) || [];

            const card = document.createElement('div');
            card.className = 'sheet-card';
            card.dataset.sheetName = sheetName;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong>ì‹œíŠ¸: ${sheetName}</strong>
                    <select class="cat-select" style="width:150px;">
                        <option value="ë¯¸ì‚¬ìš©">ë¯¸ì‚¬ìš©</option>
                        <option value="ë‚šì‹œ" ${sheetName.includes('ë‚šì‹œ')?'selected':''}>ë‚šì‹œ</option>
                        <option value="ìš”ë¦¬" ${sheetName.includes('ìš”ë¦¬')?'selected':''}>ìš”ë¦¬</option>
                        <option value="ì›ì˜ˆ" ${sheetName.includes('ì›ì˜ˆ')?'selected':''}>ì›ì˜ˆ</option>
                        <option value="ìƒˆ ê´€ì°°" ${sheetName.includes('ìƒˆ')?'selected':''}>ìƒˆ ê´€ì°°</option>
                        <option value="ê³¤ì¶© ì±„ì§‘" ${sheetName.includes('ê³¤ì¶©')?'selected':''}>ê³¤ì¶© ì±„ì§‘</option>
                    </select>
                </div>
                <div class="mapping-grid">
                    ${fields.map(f => `
                        <div>
                            <span style="font-size:11px; color:#666;">${f.label}</span>
                            <select class="header-match" data-field="${f.key}">
                                <option value="">-- ì œì™¸ --</option>
                                ${headers.map(h => `<option value="${h}" ${f.hints.some(hint => String(h).includes(hint)) ? 'selected' : ''}>${h}</option>`).join('')}
                            </select>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(card);
        });
        document.getElementById('setupArea').style.display = 'block';
    }

    document.getElementById('downloadBtn').addEventListener('click', function() {
        const result = { "ë‚šì‹œ":[], "ìš”ë¦¬":[], "ì›ì˜ˆ":[], "ìƒˆ ê´€ì°°":[], "ê³¤ì¶© ì±„ì§‘":[], "my_levels": {"ë‚šì‹œ":1,"ìš”ë¦¬":1,"ì›ì˜ˆ":1,"ìƒˆ ê´€ì°°":1,"ê³¤ì¶© ì±„ì§‘":1} };
        let count = 0;

        document.querySelectorAll('.sheet-card').forEach(card => {
            const cat = card.querySelector('.cat-select').value;
            if (cat === "ë¯¸ì‚¬ìš©") return;

            const sheetName = card.dataset.sheetName;
            // ğŸ’¡ ì¤‘ìš”: ì—‘ì…€ì˜ ë¹ˆ ì¤„ì„ ë¬´ì‹œí•˜ê³  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });
            
            const mapping = {};
            card.querySelectorAll('.header-match').forEach(sel => {
                if (sel.value) mapping[sel.dataset.field] = sel.value;
            });

            rows.forEach(row => {
                const getV = (k) => row[mapping[k]] ? String(row[mapping[k]]) : "";
                if (!getV('name')) return; // ì´ë¦„ì´ ì—†ìœ¼ë©´ ì €ì¥ ì•ˆ í•¨

                result[cat].push({
                    "name": getV('name'),
                    "level": getV('level').replace(/[^0-9]/g, '') || "1",
                    "location": getV('location'),
                    "weather": getV('weather') || "ë¬´ê´€",
                    "time": getV('time') || "ì¢…ì¼",
                    "price": getV('price').replace(/[^0-9]/g, ''),
                    "size": getV('size'),
                    "stars": [false, false, false, false, false],
                    "img_path": "",
                    "memo": getV('memo'),
                    "sub_type": getV('sub_type')
                });
                count++;
            });
        });

        if (count === 0) {
            alert("ë³€í™˜í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤! ì‹œíŠ¸ë³„ ì¹´í…Œê³ ë¦¬ì™€ 'ì´ë¦„' ì—´ ë§¤ì¹­ì„ í™•ì¸í•˜ì„¸ìš”.");
            return;
        }

        const fileName = prompt("íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", "ë„ê°ë°ì´í„°.json");
        if (!fileName) return;

        const blob = new Blob([JSON.stringify(result, null, 4)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName.endsWith('.json') ? fileName : fileName + ".json";
        a.click();
        document.getElementById('status').innerText = count + "ê°œ ë°ì´í„° ë³€í™˜ ì„±ê³µ!";
    });
</script>
</body>
</html>
