<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‘ê·¼ë‘ê·¼íƒ€ìš´ ë„ê° ë³€í™˜ê¸° ë§ˆìŠ¤í„°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #4CAF50; --bg: #f4f7f6; --card: #ffffff; }
        body { font-family: 'Malgun Gothic', sans-serif; background: var(--bg); padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: auto; background: var(--card); padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); text-align: center; border-bottom: 2px solid var(--primary); padding-bottom: 15px; }
        
        .upload-zone { border: 3px dashed var(--primary); padding: 40px; text-align: center; cursor: pointer; margin: 20px 0; border-radius: 10px; transition: 0.3s; }
        .upload-zone:hover { background: #e8f5e9; }
        
        .sheet-card { background: #f9f9f9; border: 1px solid #ddd; padding: 20px; margin-bottom: 25px; border-radius: 10px; }
        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .mapping-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .field-box { display: flex; flex-direction: column; }
        .field-label { font-size: 0.85em; font-weight: bold; color: #555; margin-bottom: 5px; }
        
        select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; background: white; }
        .cat-select { font-weight: bold; border-color: var(--primary); color: var(--primary); }

        .btn-save { width: 100%; padding: 20px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.2em; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.3s; }
        .btn-save:hover { background: #45a049; transform: translateY(-2px); }
        .btn-save:disabled { background: #ccc; cursor: not-allowed; }

        .status-bar { text-align: center; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ë„ê° ë°ì´í„° ë³€í™˜ê¸° Pro</h1>
    <p style="text-align: center; color: #666;">ì—‘ì…€ ë°ì´í„°ë¥¼ í”„ë¡œê·¸ë¨ ì „ìš© JSON íŒŒì¼ë¡œ ì •ë°€ ë³€í™˜í•©ë‹ˆë‹¤.</p>

    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
        <strong>ğŸ“ ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ì„ í´ë¦­í•˜ì—¬ ë¶ˆëŸ¬ì˜¤ê¸°</strong>
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
    </div>

    <div id="setupArea" style="display:none;">
        <div id="sheetsContainer"></div>
        <button class="btn-save" id="downloadBtn">JSON íŒŒì¼ë¡œ ì €ì¥í•˜ê¸°</button>
        <div id="status" class="status-bar"></div>
    </div>
</div>

<script>
    let workbook = null;
    let originalFileName = "ë„ê°ë°ì´í„°";

    // ë§µí•‘í•  ë°ì´í„° í•„ë“œ ì •ì˜ (ë¼ë²¨ëª…, ì½”ë“œí‚¤, ìë™ë§¤ì¹­ íŒíŠ¸)
    const fields = [
        { key: 'name', label: 'ì´ë¦„(í•„ìˆ˜)*', hints: ['ì´ë¦„', 'ëª…ì¹­', 'ë¬¼ê³ ê¸°', 'ì‘ë¬¼', 'ê³¤ì¶©', 'ìƒˆ'] },
        { key: 'level', label: 'ë ˆë²¨*', hints: ['ë ˆë²¨', 'ë‚œì´ë„', 'Lv', 'level'] },
        { key: 'location', label: 'ì¥ì†Œ', hints: ['ì¥ì†Œ', 'ìœ„ì¹˜', 'íšë“ì²˜', 'ì–´ì¥'] },
        { key: 'weather', label: 'ë‚ ì”¨', hints: ['ë‚ ì”¨', 'ê¸°ìƒ', 'weather'] },
        { key: 'time', label: 'ì‹œê°„', hints: ['ì‹œê°„', 'ì¶œí˜„ì‹œê°„', 'time'] },
        { key: 'price', label: 'ê°€ê²©', hints: ['ê°€ê²©', 'ê¸ˆì•¡', 'íŒë§¤ê°€'] },
        { key: 'size', label: 'í¬ê¸°', hints: ['í¬ê¸°', 'ì‚¬ì´ì¦ˆ', 'size'] },
        { key: 'sub_type', label: 'êµ¬ë¶„(ì¢…ë¥˜)', hints: ['êµ¬ë¶„', 'ì¢…ë¥˜', 'íƒ€ì…', 'ë¶„ë¥˜'] },
        { key: 'memo', label: 'ë©”ëª¨', hints: ['ë©”ëª¨', 'ë¹„ê³ ', 'íŠ¹ì´ì‚¬í•­'] }
    ];

    const categories = ["ë¯¸ì‚¬ìš©", "ë‚šì‹œ", "ìš”ë¦¬", "ì›ì˜ˆ", "ìƒˆ ê´€ì°°", "ê³¤ì¶© ì±„ì§‘"];

    // íŒŒì¼ ë¡œë“œ ì´ë²¤íŠ¸
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        originalFileName = file.name.split('.').slice(0, -1).join('.'); // í™•ì¥ì ì œê±°í•œ ì´ë¦„ ì €ì¥
        
        const reader = new FileReader();
        reader.onload = function(evt) {
            workbook = XLSX.read(evt.target.result, { type: 'binary' });
            renderSheets();
        };
        reader.readAsBinaryString(file);
    });

    // ì‹œíŠ¸ë³„ ì„¤ì • í™”ë©´ ë Œë”ë§
    function renderSheets() {
        const container = document.getElementById('sheetsContainer');
        container.innerHTML = "";
        
        workbook.SheetNames.forEach((sheetName, idx) => {
            const sheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            if (data.length === 0) return;
            
            const headers = data[0]; // ì²« ë²ˆì§¸ ì¤„ì„ í—¤ë”ë¡œ ì¸ì‹

            const card = document.createElement('div');
            card.className = 'sheet-card';
            card.dataset.sheetName = sheetName;

            card.innerHTML = `
                <div class="sheet-header">
                    <strong>ğŸ“„ ì‹œíŠ¸ëª…: ${sheetName}</strong>
                    <div>
                        <span style="font-size:0.9em;">ì¹´í…Œê³ ë¦¬ ì§€ì •: </span>
                        <select class="cat-select">
                            ${categories.map(c => `<option value="${c}" ${sheetName.includes(c)?'selected':''}>${c}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="mapping-grid">
                    ${fields.map(f => `
                        <div class="field-box">
                            <span class="field-label">${f.label}</span>
                            <select class="header-match" data-field-key="${f.key}">
                                <option value="">-- ì œì™¸ --</option>
                                ${headers.map(h => {
                                    const isMatch = f.hints.some(hint => String(h).includes(hint));
                                    return `<option value="${h}" ${isMatch ? 'selected' : ''}>${h}</option>`;
                                }).join('')}
                            </select>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(card);
        });

        document.getElementById('setupArea').style.display = 'block';
        window.scrollTo({ top: document.getElementById('setupArea').offsetTop, behavior: 'smooth' });
    }

    // JSON ë³€í™˜ ë° ì €ì¥
    document.getElementById('downloadBtn').addEventListener('click', function() {
        const result = { 
            "ë‚šì‹œ":[], "ìš”ë¦¬":[], "ì›ì˜ˆ":[], "ìƒˆ ê´€ì°°":[], "ê³¤ì¶© ì±„ì§‘":[], 
            "my_levels": {"ë‚šì‹œ":1,"ìš”ë¦¬":1,"ì›ì˜ˆ":1,"ìƒˆ ê´€ì°°":1,"ê³¤ì¶© ì±„ì§‘":1} 
        };

        const sheetCards = document.querySelectorAll('.sheet-card');
        let totalCount = 0;

        sheetCards.forEach(card => {
            const cat = card.querySelector('.cat-select').value;
            if (cat === "ë¯¸ì‚¬ìš©") return;

            const sheetName = card.dataset.sheetName;
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
            
            // í˜„ì¬ ì‹œíŠ¸ì˜ ë§¤ì¹­ ë§µ ìƒì„±
            const mapping = {};
            card.querySelectorAll('.header-match').forEach(sel => {
                if (sel.value) mapping[sel.dataset.fieldKey] = sel.value;
            });

            rows.forEach(row => {
                const getVal = (k) => row[mapping[k]] ? String(row[mapping[k]]) : "";
                
                // ë°ì´í„° ì •ì œ ë¡œì§ (ìˆ«ìë§Œ ì¶”ì¶œ ë“±)
                const item = {
                    "name": getVal('name'),
                    "level": getVal('level').replace(/[^0-9]/g, '') || "1",
                    "location": getVal('location'),
                    "weather": getVal('weather') || "ë¬´ê´€",
                    "time": getVal('time') || "ì¢…ì¼",
                    "price": getVal('price').replace(/[^0-9]/g, ''),
                    "size": getVal('size'),
                    "stars": [false, false, false, false, false],
                    "img_path": "",
                    "memo": getVal('memo'),
                    "sub_type": getVal('sub_type')
                };

                if (item.name) {
                    result[cat].push(item);
                    totalCount++;
                }
            });
        });

        if (totalCount === 0) {
            alert("ë³€í™˜í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ì™€ í•„ìˆ˜ í•­ëª©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            return;
        }

        // íŒŒì¼ ì´ë¦„ ì…ë ¥ ë° ìœ„ì¹˜ ì„ íƒì°½ ìœ ë„
        let saveName = prompt("ì €ì¥í•  íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", originalFileName + ".json");
        if (saveName === null) return; // ì·¨ì†Œ ì‹œ ì¤‘ë‹¨
        if (!saveName.toLowerCase().endsWith('.json')) saveName += ".json";

        const blob = new Blob([JSON.stringify(result, null, 4)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = saveName;
        a.click();

        document.getElementById('status').innerHTML = `âœ… <span style="color:blue">${saveName}</span>ìœ¼ë¡œ ${totalCount}ê°œì˜ ë°ì´í„°ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤.`;
    });
</script>

</body>
</html>
